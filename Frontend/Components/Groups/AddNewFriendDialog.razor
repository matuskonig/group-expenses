@using Frontend.Components.Dialogs
@using Frontend.Extensions
@using Frontend.Providers
@using Entities.AuthDto
@using Entities.GroupDto
@using Frontend.Helpers
@using Frontend.Components.Forms
@using Frontend.Services
@inject GroupService _groupService

<OpenableDialog>
    <Opener>
        <button @onclick="@context.OpenDialog">Add new user</button>
    </Opener>
    <Title>
        <h3>Add new user to group</h3>
    </Title>
    <ChildContent>
        <UserSelectForm
            OnSubmit="user => HandleAddNewFriend(user, context)"
            Users="@PossibleNewUsers()"/>
    </ChildContent>
</OpenableDialog>

@code {

    [CascadingParameter]
    public CurrentUserProvider CurrentUserProvider { get; set; }

    [Parameter]
    public SinglePurposeUserGroupDto Group { get; set; }

    private IEnumerable<UserDto> PossibleNewUsers()
    {
        return CurrentUserProvider
            ?.CurrentUser
            ?.Friends()
            ?.Except(Group.GroupUsers, new PropertyEqualityComparer<UserDto, string>(user => user.Id))
            .OrderBy(user => user.UserName) ?? Enumerable.Empty<UserDto>();
    }

    private async Task HandleAddNewFriend(UserDto user, OpenableDialog dialog)
    {
        await _groupService.ModifyUserGroup(new SinglePurposeUserGroupDto
        {
            Id = Group.Id,
            GroupUsers = Group.GroupUsers.Append(user)
        });
        await _groupService.LoadAll();
        dialog.CloseDialog();
    }
}